# proj8-mutil linux kernel.md
### 项目名称
双Linux内核并行执行

### 项目描述与背景
目前需要在同一台物理机上面同时使用多个操作系统的主流做法通常来是通过虚拟化的方法。如下图所示：

```
          | ---------------------------|
          |         GUEST 0S B         | 
          | -------------------------- |
          |         HOST OS  A         |
          |----------------------------|
          |         hardware           |
          |----------------------------|
```
- 在物理机上面先跑一个HOST OS A
- 然后在HOST OS A通过虚拟化软件技术在HOST OS A上面运行一个GUEST OS B. 

通过上面的方法可以在同一硬件上面运行两套操作系统软件。虽然两套操作系统可以同时运行，但是从操作系统内核本身来看，OS A kernel和OS B kernel看到的硬件信息不是一样的。
    
例如：
对于QEMU-KVM启动的虚拟机的方法在同一个硬件上面运行两套操作系统软件。就单纯从CPU和内存来说就完全不一样：
- OS A和OS B CPU处于不同的特权级。  
- OS A使用内存的时候的从（虚拟内存）-->（物理内存地址）翻译路径和OS B（虚拟内存）--> OS B（物理内存）的地址翻译路径也完全不同。
- 除此之外还有外设（磁盘、网卡等）的访问路径，也是十分不同。 

正是因为这些不同，导致了我们无法将OS B 和 OS A同等看待。 在有些场景，我们需要一种方式来实现同时运行两个内核，同时两个内核所看到的硬件信息和状态是完全一致的。

一种典型的应用场景是内核热升级的场景:
假设某服务器上面 使用的linux 4.19的内核，假设目前4.19的内核已经不再满足业务需求，这个时候需要将内核升级到linux 5.15。

传统的做法：
- 1、将服务器上面的业务迁走。
- 2、然后升级内核到linux 5.15。
- 3、然后重启服务器，加载和运行升级后的linux内核。
- 4、然后再将业务迁到已经升级好内核的机器上面来。
整个过程的时间是比较漫长的。

双Linux内核并行执行：
```
          | ------------------------------------ |
          |       OS  A     |       OS B         |
          |--------------------------------------|
          |               hardware               |
          |--------------------------------------|
```
- 1 、通过某种方式（例如kexec）在运行着linux 4.19 内核操作系统上面隔离一些资源出来（CPU、内存等）运行一个linux 5.15内核的操作系统. 同时不要终止linux 4.19内核的执行（划分出来的资源4.19内核不再去访问）。
- 2、 运行在4.19内核上面的业务继续运行。直到linux5.15的操作的操作系统完全运行起来之后，将4.19内核上面跑的业务迁移到5.15内核上面继续运行。
- 3、 然后将linux 4.19的内核终止运行，并将其所占有的一切资源给到linux 5.15的操作系统。

通过上述方式就可以无感的切换内核。


### 功能描述

#### 基础功能：
本项目的所有功能可在QEMU虚拟机里面完成
- 1、首先使用QEMU启动一个虚拟机，运行着linux A。
- 2、然后通过kexec-tools加载运行linux B, 在加载运行linux B的时候不要停止linux A的运行。同时A需要在加载运行linux B之前为linux B提前预留好linux B所能够使用到的（cpu和内存等）资源，
避免由于资源的相互使用导致内核carsh.
- 3、QEMU 启动虚拟机的时候为虚拟机配置两个串口: 串口A 和串口B, linux A使用串口A, linux B使用串口B。

为了简化题目难度，可以做如下裁剪：
- 1、linux A和linux B的根文件系统可以采用initramfs， 这样就不需要考虑磁盘设备的共用问题。
- 2、QEMU 启动虚拟机的时候为虚拟机配置两个串口：串口A 和串口B, linux A使用串口A、 linux。 B使用串口B，这样就不涉及到串口资源的并发访问问题。

最终可以分别通过串口A和串口B访问到linux A和linux B


环境要求：为避免内核版本不同造成差异，在Linux 5.15进行开发

#### 扩展功能：
- 1、linux A和linux B两个内核之间可以互相通信（例如核间中断方式）
- 2、linux A和linux B两个内核共用一块网卡设备。

### 所属赛道

2022全国大学生操作系统比赛的“OS功能设计”赛道


### 参赛要求

- 以小组为单位参赛，最多三人一个小组，且小组成员是来自同一所高校的本科生（2022年春季学期或之后本科毕业的大一~大四的学生）
- 如学生参加了多个项目，参赛学生选择一个自己参加的项目参与评奖
- 请遵循“2022全国大学生操作系统比赛”的章程和技术方案要求



### 项目导师
huangjie.albert@bytedance.com

### 难度
难

### 参考资料
[https://lwn.net/Articles/271991/](https://note.youdao.com/)  
[https://nan01ab.github.io/2017/12/Multi-Kernel.html](https://note.youdao.com/)  
[http://www.popcornlinux.org/](https://note.youdao.com/)  
[https://github.com/horms/kexec-tools](https://note.youdao.com/)  

### License
* [GPL-2.0](https://opensource.org/licenses/GPL-2.0)

## 预期目标

完成基础功能和扩展功能的开发，并输出说明文档一篇。

**注意：下面的内容是建议内容，不要求必须全部完成。选择本项目的同学也可与导师联系，提出自己的新想法，如导师认可，可加入预期目标**

参考任务描述部分。
